<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://cdn.web-global.fds.api.mi-img.com/mcfe--mi-account/static/favicon_new.ico">
    <link rel="preload" as="style"
        href="https://font.sec.miui.com/font/css?family=MiSans:300,400,500,600,700:Chinese_Simplify,Chinese_Traditional,Latin&display=swap"
        onload="this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet"
            href="https://font.sec.miui.com/font/css?family=MiSans:300,400,500,600,700:Chinese_Simplify,Chinese_Traditional,Latin&display=swap">
    </noscript>
    <title id="pageTitle">授权成功</title>
    <style>
        body {
            background: white;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: MiSans, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .frame {
            background: rgba(255, 255, 255, 0.95);
            width: 50%;
            max-width: 600px;
            padding: 40px 45px;
            border-radius: 8px;
            box-shadow: 0 20px 50px 0 rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .logo-frame {
            text-align: center;
        }

        .title-frame {
            margin: 20px 0 20px 0;
            font-size: 26px;
            font-weight: 500;
            line-height: 40px;
            color: #000000;
            transition: color 0.3s ease;
        }

        .content-frame {
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.6);
            transition: color 0.3s ease;
            text-align: left;
            line-height: 1.8;
        }

        button {
            background-color: #ff5c00;
            border: none;
            border-radius: 4px;
            padding: 0 20px;
            text-align: center;
            width: 100%;
            display: inline-block;
            font-size: 18px;
            font-weight: 400;
            height: 46px;
            line-height: 46px;
            overflow: hidden;
            position: relative;
            text-overflow: ellipsis;
            transition: all .3s cubic-bezier(.645, .045, .355, 1);
            vertical-align: top;
            white-space: nowrap;
            cursor: pointer;
            color: #fff;
        }

        button:hover {
            background-color: #e55500;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 92, 0, 0.3);
        }

        .text-input-container {
            margin-top: 20px;
            position: relative;
            width: 100%;
        }

        .text-input {
            width: 100%;
            height: 46px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 0 55px 0 15px;
            font-size: 16px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.8);
            color: #666666;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
            cursor: text;
        }

        .text-input:focus {
            border-color: #ff5c00;
            box-shadow: 0 0 0 2px rgba(255, 92, 0, 0.2);
        }

        .text-input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .copy-button {
            position: absolute;
            right: 2px;
            top: 2px;
            background-color: #ff5c00;
            border: none;
            border-radius: 2px;
            width: 42px;
            height: 42px;
            cursor: pointer;
            color: #fff;
            transition: all .3s cubic-bezier(.645, .045, .355, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 0;
        }

        .copy-button:hover {
            background-color: #e55500;
        }

        .copy-icon {
            width: 18px;
            height: 18px;
            fill: #ffffff;
            display: block;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .address-display-container {
            position: relative;
            width: 100%;
        }

        .address-display {
            width: 100%;
            height: 46px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 0 15px;
            font-size: 16px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.8);
            color: #666666;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
            cursor: text;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .button-container #buttonArea {
            margin-top: 20px;
            width: 100%;
        }



        /* 深色模式样式 */
        @media (prefers-color-scheme: dark) {
            body {
                background: #121212 !important;
                color: #ffffff !important;
            }

            .frame {
                background: rgba(255, 255, 255, 0.08) !important;
                box-shadow: 0 20px 50px 0 rgba(0, 0, 0, 0.3) !important;
            }

            .title-frame {
                color: #ffffff !important;
            }

            .content-frame {
                color: rgba(255, 255, 255, 0.7) !important;
            }

            .text-input {
                border-color: rgba(255, 255, 255, 0.3) !important;
                background: rgba(255, 255, 255, 0.08) !important;
                color: #ffffff !important;
            }

            .text-input::placeholder {
                color: rgba(255, 255, 255, 0.5) !important;
            }

            .copy-icon {
                fill: #ffffff !important;
            }

            .copy-text {
                color: #ffffff !important;
            }

            button:hover {
                background-color: #e55500 !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 12px rgba(255, 92, 0, 0.4) !important;
            }


            .address-display {
                border-color: rgba(255, 255, 255, 0.3) !important;
                background: rgba(255, 255, 255, 0.08) !important;
                color: #ffffff !important;
            }

            .address-display::placeholder {
                color: rgba(255, 255, 255, 0.5) !important;
            }
        }

        .button-row {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }

        #buttonArea {
            flex: 1;
            display: inline-block;
            text-align: center;
            background-color: #ff5c00;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 400;
            height: 46px;
            line-height: 46px;
            text-decoration: none;
            cursor: pointer;
            transition: all .3s cubic-bezier(.645, .045, .355, 1);
            white-space: nowrap;
        }

        #buttonArea:hover {
            background-color: #e55500;
        }

        #closeButton {
            width: 120px;
            background-color: #bbb;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #closeButton:hover {
            background-color: #999;
        }
    </style>
</head>

<body>
    <div class="frame">
        <!-- XIAOMI LOGO-->
        <div class="logo-frame">
            <svg width="50" height="50" viewBox="0 0 193 193" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink">
                <title>Xiaomi Home</title>
                <desc>Xiaomi Home Copilot Redirect Page.</desc>
                <defs>
                    <polygon id="path-1"
                        points="1.78097075e-14 0.000125324675 192.540685 0.000125324675 192.540685 192.540058 1.78097075e-14 192.540058">
                    </polygon>
                </defs>
                <g id="\u9875\u9762-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <g id="\u7F16\u7EC4">
                        <mask id="mask-2" fill="white">
                            <use xlink:href="#path-1"></use>
                        </mask>
                        <g id="Clip-2"></g>
                        <path
                            d="M172.473071,20.1164903 C154.306633,2.02148701 128.188344,-1.78097075e-14 96.2706558,-1.78097075e-14 C64.312237,-1.78097075e-14 38.155724,2.0452987 19.9974318,20.1872987 C1.84352597,38.3261656 1.78097075e-14,64.4406948 1.78097075e-14,96.3640227 C1.78097075e-14,128.286724 1.84352597,154.415039 20.0049513,172.556412 C38.1638701,190.704052 64.3141169,192.540058 96.2706558,192.540058 C128.225942,192.540058 154.376815,190.704052 172.53636,172.556412 C190.694653,154.409399 192.540685,128.286724 192.540685,96.3640227 C192.540685,64.3999643 190.672721,38.2553571 172.473071,20.1164903"
                            id="Fill-1" fill="#FF6900" mask="url(#mask-2)"></path>
                        <path
                            d="M89.1841721,131.948836 C89.1841721,132.594885 88.640263,133.130648 87.9779221,133.130648 L71.5585097,133.130648 C70.8848896,133.130648 70.338474,132.594885 70.338474,131.948836 L70.338474,89.0100961 C70.338474,88.3584078 70.8848896,87.8251513 71.5585097,87.8251513 L87.9779221,87.8251513 C88.640263,87.8251513 89.1841721,88.3584078 89.1841721,89.0100961 L89.1841721,131.948836 Z"
                            id="Fill-3" fill="#FFFFFF" mask="url(#mask-2)"></path>
                        <path
                            d="M121.332896,131.948836 C121.332896,132.594885 120.786481,133.130648 120.121633,133.130648 L104.492393,133.130648 C103.821906,133.130648 103.275491,132.594885 103.275491,131.948836 L103.275491,131.788421 L103.275491,94.9022357 C103.259198,88.4342292 102.889491,81.7863818 99.5502146,78.445226 C96.6790263,75.5652649 91.3251562,74.9054305 85.7557276,74.7669468 L57.4242049,74.7669468 C56.7555977,74.7669468 56.2154484,75.3045896 56.2154484,75.9512649 L56.2154484,128.074424 L56.2154484,131.948836 C56.2154484,132.594885 55.6640198,133.130648 54.9954127,133.130648 L39.3555198,133.130648 C38.6875393,133.130648 38.1498964,132.594885 38.1498964,131.948836 L38.1498964,60.5996188 C38.1498964,59.9447974 38.6875393,59.4121675 39.3555198,59.4121675 L84.4786692,59.4121675 C96.2717211,59.4121675 108.599909,59.9498104 114.680036,66.0380831 C120.786481,72.1533006 121.332896,84.4595571 121.332896,96.2657682 L121.332896,131.948836 Z"
                            id="Fill-5" fill="#FFFFFF" mask="url(#mask-2)"></path>
                        <path
                            d="M153.53056,131.948836 C153.53056,132.594885 152.978505,133.130648 152.316164,133.130648 L136.678778,133.130648 C136.010797,133.130648 135.467515,132.594885 135.467515,131.948836 L135.467515,60.5996188 C135.467515,59.9447974 136.010797,59.4121675 136.678778,59.4121675 L152.316164,59.4121675 C152.978505,59.4121675 153.53056,59.9447974 153.53056,60.5996188 L153.53056,131.948836 Z"
                            id="Fill-7" fill="#FFFFFF" mask="url(#mask-2)"></path>
                    </g>
                </g>
            </svg>
        </div>
        <!-- TITLE -->
        <div class="title-frame">
            <a id="titleArea">授权成功</a>
        </div>
        <!-- AUTH INFO -->
        <div class="text-input-container">
            <input type="text" class="text-input" id="textInput" placeholder="等待参数处理..." readonly
                onclick="selectAllText()">

            <button class="copy-button" onclick="copyText()" title="复制">
                <svg class="copy-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" />
                </svg>
                <span class="copy-text" style="display: none;">复制</span>
            </button>
        </div>
        <!-- BUTTON -->
        <div class="button-container">
            <div class="address-display-container">
                <input type="text" class="address-display" id="addressDisplay"
                    placeholder="请输入跳转地址，例如: 192.168.1.100:8080">
            </div>
        </div>
        <!-- TIP -->
        <div class="content-frame" id="contentArea">
            <ol>
                <li>如果设置了跳转链接，可以直接"点击跳转"进行授权；如果没有设置，可以直接在输入框中输入跳转地址，该跳转地址存储在浏览器Cookie中。</li>
                <li>也可以点击复制图标，复制授权信息，然后回到应用页面输入授权信息，继续操作。</li>
            </ol>
        </div>
        <div class="button-row">
            <button id="closeButton" onClick="closePage()">关闭页面</button>
            <a id="buttonArea" href="#" onclick="handleJump(); return false;">点击跳转</a>
        </div>
    </div>

    <script>
        // 多语言配置
        const translations = {
            'zh-CN': {
                title: '授权成功',
                content: `<ol>
    <li>如果设置了跳转链接，可以直接"点击跳转"进行授权；如果没有设置，可以直接在输入框中输入跳转地址，该跳转地址存储在浏览器Cookie中。</li>
    <li>也可以点击复制图标，复制授权信息，然后回到应用页面输入授权信息，继续操作。</li>
    </ol>`,
                placeholder: '等待参数处理...',
                copyButton: '复制',
                copySuccess: '已复制',
                buttonPlaceholder: '点击跳转',
                noParamsTitle: '无参数传入',
                noParamsContent: '页面将自动关闭',
                copyFailed: '复制失败，请手动复制',
                encodingFailed: '参数处理失败',
                settingsTitle: '设置IP地址',
                settingsPlaceholder: '请输入IP地址，例如: 192.168.1.100:8080',
                addressPlaceholder: '请输入跳转地址，例如: 192.168.1.100:8080',
                settingsSaved: '设置已保存',
                settingsCancel: '取消',
                settingsSave: '保存',
                settingsRequired: '请先设置IP地址',
                settingsInvalidIP: '请输入完整地址（如：https://192.168.1.100:8080）',
                noParamsToSend: '没有参数可发送',
                requestFailed: '请求失败',
                closeHintTitle: '请手动关闭页面',
                closeHintContent: '由于浏览器安全限制，请手动关闭此页面',
                updateSuccessTitle: '地址更新成功',
                updateSuccessContent: '地址更新成功，当前跳转地址为：\r\n',
                updateErrorTitle: '地址无效',
                noParamsCopyTitle: '无参数可复制',
                noParamsJumpTitle: '无参数可跳转',
                noParamsPlaceholder: '无参数传入'
            },
            'zh-TW': {
                title: '授權成功',
                content: `<ol>
    <li>如果已設置跳轉連結，可直接點擊「點擊跳轉」進行授權；如未設置，可直接在輸入框中輸入跳轉地址，該地址將存儲於瀏覽器Cookie中。</li>
    <li>也可點擊複製圖示，複製授權資訊，然後回到應用頁面輸入授權資訊繼續操作。</li>
    </ol>`,
                placeholder: '等待參數處理...',
                copyButton: '複製',
                copySuccess: '已複製',
                buttonPlaceholder: '點擊跳轉',
                noParamsTitle: '無參數傳入',
                noParamsContent: '頁面將自動關閉',
                copyFailed: '複製失敗，請手動複製',
                encodingFailed: '參數處理失敗',
                settingsTitle: '設置IP地址',
                settingsPlaceholder: '請輸入IP地址，例如: 192.168.1.100:8080',
                addressPlaceholder: '請輸入跳轉地址，例如: 192.168.1.100:8080',
                settingsSaved: '設置已保存',
                settingsCancel: '取消',
                settingsSave: '保存',
                settingsRequired: '請先設置IP地址',
                settingsInvalidIP: '請輸入完整地址（如：https://192.168.1.100:8080）',
                noParamsToSend: '沒有參數可發送',
                requestFailed: '請求失敗',
                closeHintTitle: '請手動關閉頁面',
                closeHintContent: '由於瀏覽器安全限制，請手動關閉此頁面',
                updateSuccessTitle: '地址更新成功',
                updateSuccessContent: '地址更新成功，當前跳轉地址為：\r\n',
                updateErrorTitle: '地址無效',
                noParamsCopyTitle: '無參數可複製',
                noParamsJumpTitle: '無參數可跳轉',
                noParamsPlaceholder: '無參數傳入'
            },
            'en': {
                title: 'Authorization Successful',
                content: `<ol>
    <li>If a redirect link is set, you can directly click "Click to Jump" to authorize. If not set, you can directly enter the redirect address in the input box, which will be stored in the browser Cookie.</li>
    <li>You can also click the copy icon to copy the authorization info, then return to the app page, paste the info and continue.</li>
    </ol>`,
                placeholder: 'Waiting for parameter processing...',
                copyButton: 'Copy',
                copySuccess: 'Copied',
                buttonPlaceholder: 'Click to Jump',
                noParamsTitle: 'No Parameters',
                noParamsContent: 'Page will close automatically',
                copyFailed: 'Copy failed, please copy manually',
                encodingFailed: 'Parameter processing failed',
                settingsTitle: 'Set IP Address',
                settingsPlaceholder: 'Enter IP address, e.g.: 192.168.1.100:8080',
                addressPlaceholder: 'Enter redirect address, e.g.: 192.168.1.100:8080',
                settingsSaved: 'Settings saved',
                settingsCancel: 'Cancel',
                settingsSave: 'Save',
                settingsRequired: 'Please set IP address first',
                settingsInvalidIP: 'Please enter a valid IP address, format: 192.168.1.100:8080',
                noParamsToSend: 'No parameters to send',
                requestFailed: 'Request failed',
                closeHintTitle: 'Please close this page manually',
                closeHintContent: 'Due to browser security restrictions, please close this page manually',
                updateSuccessTitle: 'Address updated successfully',
                updateSuccessContent: 'Address updated successfully, current redirect address is:\r\n',
                updateErrorTitle: 'Invalid address',
                noParamsCopyTitle: 'No parameters to copy',
                noParamsJumpTitle: 'No parameters to jump',
                noParamsPlaceholder: 'No parameters'
            },
            'ja': {
                title: '認証成功',
                content: `<ol>
    <li>リダイレクトリンクが設定されている場合は「クリックしてジャンプ」をクリックして認証できます。未設定の場合は入力ボックスに直接リダイレクト先を入力してください（ブラウザのCookieに保存されます）。</li>
    <li>また、コピーアイコンをクリックして認証情報をコピーし、アプリページに戻って貼り付けて続行することもできます。</li>
    </ol>`,
                placeholder: 'パラメータ処理中...',
                copyButton: 'コピー',
                copySuccess: 'コピー済み',
                buttonPlaceholder: 'クリックしてジャンプ',
                noParamsTitle: 'パラメータなし',
                noParamsContent: 'ページは自動的に閉じられます',
                copyFailed: 'コピーに失敗しました。手動でコピーしてください',
                encodingFailed: 'パラメータ処理に失敗しました',
                settingsTitle: 'IPアドレス設定',
                settingsPlaceholder: 'IPアドレスを入力してください、例: 192.168.1.100:8080',
                addressPlaceholder: 'リダイレクト先を入力してください、例: 192.168.1.100:8080',
                settingsSaved: '設定が保存されました',
                settingsCancel: 'キャンセル',
                settingsSave: '保存',
                settingsRequired: '先にIPアドレスを設定してください',
                settingsInvalidIP: '有効なIPアドレスを入力してください、形式: 192.168.1.100:8080',
                noParamsToSend: '送信するパラメータがありません',
                requestFailed: 'リクエストに失敗しました',
                closeHintTitle: 'ページを手動で閉じてください',
                closeHintContent: 'ブラウザのセキュリティ制限により、このページを手動で閉じてください',
                updateSuccessTitle: 'アドレスが更新されました',
                updateSuccessContent: 'アドレスが更新されました、現在のリダイレクトアドレスは：\r\n',
                updateErrorTitle: '無効なアドレス',
                noParamsCopyTitle: 'コピーするパラメータがありません',
                noParamsJumpTitle: 'ジャンプするパラメータがありません',
                noParamsPlaceholder: 'パラメータがありません'
            },
            'ko': {
                title: '인증 성공',
                content: `<ol>
    <li>리디렉션 링크가 설정되어 있으면 "클릭하여 이동"을 눌러 인증할 수 있습니다. 설정되어 있지 않으면 입력 상자에 직접 리디렉션 주소를 입력하세요(브라우저 쿠키에 저장됨).</li>
    <li>또한 복사 아이콘을 눌러 인증 정보를 복사한 후 앱 페이지로 돌아가 입력하고 계속 진행할 수 있습니다.</li>
    </ol>`,
                placeholder: '매개변수 처리 중...',
                copyButton: '복사',
                copySuccess: '복사됨',
                buttonPlaceholder: '클릭하여 이동',
                noParamsTitle: '매개변수 없음',
                noParamsContent: '페이지가 자동으로 닫힙니다',
                copyFailed: '복사에 실패했습니다. 수동으로 복사하세요',
                encodingFailed: '매개변수 처리에 실패했습니다',
                settingsTitle: 'IP 주소 설정',
                settingsPlaceholder: 'IP 주소를 입력하세요, 예: 192.168.1.100:8080',
                addressPlaceholder: '리디렉션 주소를 입력하세요, 예: 192.168.1.100:8080',
                settingsSaved: '설정이 저장되었습니다',
                settingsCancel: '취소',
                settingsSave: '저장',
                settingsRequired: '먼저 IP 주소를 설정하세요',
                settingsInvalidIP: '유효한 IP 주소를 입력하세요, 형식: 192.168.1.100:8080',
                noParamsToSend: '전송할 매개변수가 없습니다',
                requestFailed: '요청에 실패했습니다',
                closeHintTitle: '페이지를 수동으로 닫아주세요',
                closeHintContent: '브라우저 보안 제한으로 인해 이 페이지를 수동으로 닫아주세요',
                updateSuccessTitle: '주소가 업데이트되었습니다',
                updateSuccessContent: '주소가 업데이트되었습니다, 현재 리다이렉트 주소는：\r\n',
                updateErrorTitle: '잘못된 주소',
                noParamsCopyTitle: '복사할 매개변수가 없습니다',
                noParamsJumpTitle: '이동할 매개변수가 없습니다',
                noParamsPlaceholder: '매개변수가 없습니다'
            }
        };

        function getBrowserLanguage() {
            const language = navigator.language || navigator.userLanguage;
            const langCode = language.toLowerCase();
            if (langCode.startsWith('zh-cn') || langCode.startsWith('zh-hans')) {
                return 'zh-CN';
            } else if (langCode.startsWith('zh-tw') || langCode.startsWith('zh-hant')) {
                return 'zh-TW';
            } else if (langCode.startsWith('ja')) {
                return 'ja';
            } else if (langCode.startsWith('ko')) {
                return 'ko';
            } else if (langCode.startsWith('en')) {
                return 'en';
            } else {
                return 'zh-CN'; // 默认中文简体
            }
        }

        // 应用语言
        function applyLanguage(langCode) {
            const lang = translations[langCode] || translations['zh-CN'];
            document.getElementById('pageTitle').textContent = lang.title;
            document.getElementById('titleArea').textContent = lang.title;
            document.getElementById('contentArea').innerHTML = lang.content;

            const textInput = document.getElementById('textInput');
            if (textInput) {
                textInput.placeholder = lang.placeholder;
            }

            const copyButton = document.querySelector('.copy-button');
            if (copyButton) {
                copyButton.title = lang.copyButton;
            }


            const mainButton = document.getElementById('buttonArea');
            if (mainButton) {
                mainButton.textContent = lang.buttonPlaceholder;
            }

            const addressDisplay = document.getElementById('addressDisplay');
            if (addressDisplay && lang.addressPlaceholder) {
                addressDisplay.placeholder = lang.addressPlaceholder;
            }
        }

        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }


        function updateJumpHref() {
            const jumpBtn = document.getElementById('buttonArea');
            const authRedirectUrl = getCookie('authRedirectUrl');
            if (!authRedirectUrl) {
                jumpBtn.href = '#';
                jumpBtn.setAttribute('disabled', 'disabled');
                jumpBtn.style.pointerEvents = 'none';
                jumpBtn.style.opacity = '0.5';
                return;
            }
            const params = window.location.search || '';
            jumpBtn.href = authRedirectUrl + (params.startsWith('?') ? params : '');
            jumpBtn.removeAttribute('disabled');
            jumpBtn.style.pointerEvents = '';
            jumpBtn.style.opacity = '';
        }

        function updateAddressDisplay() {
            const addressDisplay = document.getElementById('addressDisplay');
            const authRedirectUrl = getCookie('authRedirectUrl');
            if (authRedirectUrl) {
                addressDisplay.value = authRedirectUrl;
            } else {
                addressDisplay.value = '';
            }
            updateJumpHref();
        }

        function handleJump() {
            const jumpBtn = document.getElementById('buttonArea');
            jumpBtn.textContent = '跳转中...';
            jumpBtn.style.pointerEvents = 'none';
            jumpBtn.style.opacity = '0.7';

            let authRedirectUrl = getCookie('authRedirectUrl');
            if (!authRedirectUrl) {
                const currentLang = getBrowserLanguage();
                const lang = translations[currentLang] || translations['zh-CN'];
                alert(lang.settingsRequired || '请先设置IP地址');
                jumpBtn.textContent = lang.buttonPlaceholder || '点击跳转';
                jumpBtn.style.pointerEvents = '';
                jumpBtn.style.opacity = '';
                return false;
            }

            if (!/^https?:\/\//.test(authRedirectUrl)) {
                authRedirectUrl = 'https://' + authRedirectUrl;
            }

            const params = window.location.search || '';
            const jumpUrl = authRedirectUrl + '/api/miot/xiaomi_home_callback' + (params.startsWith('?') ? params : '');

            jumpBtn.href = jumpUrl;

            setTimeout(() => {
                window.location.href = jumpUrl;
            }, 100);

            return false;
        }

        function detectThemeChange() {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

            function handleThemeChange(e) {
                if (e.matches) {
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('light-theme');
                } else {
                    document.body.classList.add('light-theme');
                    document.body.classList.remove('dark-theme');
                }
            }

            handleThemeChange(mediaQuery);

            mediaQuery.addEventListener('change', handleThemeChange);
        }

        function selectAllText() {
            const textInput = document.getElementById('textInput');
            textInput.select();
            textInput.setSelectionRange(0, 99999);
        }

        function copyText() {
            const textInput = document.getElementById('textInput');

            textInput.select();
            textInput.setSelectionRange(0, 99999);

            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textInput.value).then(() => {
                        showCopySuccess();
                    }).catch(() => {
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
            } catch (err) {
                console.error('copy failed:', err);
                const currentLang = getBrowserLanguage();
                const lang = translations[currentLang] || translations['zh-CN'];
                alert(lang.copyFailed);
            }
        }

        function fallbackCopy() {
            const textInput = document.getElementById('textInput');
            const success = document.execCommand('copy');
            if (success) {
                showCopySuccess();
            } else {
                const currentLang = getBrowserLanguage();
                const lang = translations[currentLang] || translations['zh-CN'];
                alert(lang.copyFailed);
            }
        }

        function showCopySuccess() {
            const copyButton = document.querySelector('.copy-button');
            const copyIcon = copyButton.querySelector('.copy-icon');
            const currentLang = getBrowserLanguage();
            const lang = translations[currentLang] || translations['zh-CN'];

            const originalIcon = copyIcon.innerHTML;

            copyIcon.innerHTML = '<path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z"/>';
            copyButton.style.backgroundColor = '#4CAF50';
            copyButton.title = lang.copySuccess;

            setTimeout(() => {
                copyIcon.innerHTML = originalIcon;
                copyButton.style.backgroundColor = '#ff5c00';
                copyButton.title = lang.copyButton;
            }, 2000);
        }

        function getUrlParams() {
            const params = {};

            if (typeof URLSearchParams !== 'undefined') {
                try {
                    const urlParams = new URLSearchParams(window.location.search);

                    for (const [key, value] of urlParams.entries()) {
                        params[key] = value;
                    }
                } catch (error) {
                    console.error('URLSearchParams parse failed:', error);
                    return getUrlParamsFallback();
                }
            } else {
                console.log('browser does not support URLSearchParams, use traditional method to parse URL parameters');
                return getUrlParamsFallback();
            }
            return params;
        }

        function getUrlParamsFallback() {
            console.log('use traditional method to parse URL parameters');
            const params = {};
            const queryString = window.location.search.substring(1);

            if (queryString) {
                const pairs = queryString.split('&');
                for (let i = 0; i < pairs.length; i++) {
                    const pair = pairs[i].split('=');
                    if (pair.length === 2) {
                        const key = decodeURIComponent(pair[0]);
                        const value = decodeURIComponent(pair[1]);
                        params[key] = value;
                    }
                }
            }
            return params;
        }

        function encodeParamsToBase64(params) {
            try {
                const jsonString = JSON.stringify(params, null, 2);
                const base64String = btoa(unescape(encodeURIComponent(jsonString)));
                return base64String;
            } catch (error) {
                console.error('encode failed:', error);
                return null;
            }
        }

        window.onload = function () {
            detectThemeChange();

            const currentLang = getBrowserLanguage();
            applyLanguage(currentLang);

            updateAddressDisplay();

            const addressDisplay = document.getElementById('addressDisplay');
            if (addressDisplay) {
                // 监听输入事件，自动保存到Cookie
                addressDisplay.addEventListener('input', function (e) {
                    const value = e.target.value.trim();
                    if (value) {
                        // 验证输入格式
                        const ipOrDomainRegex = /^(https?:\/\/)?([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})?(:\d+)?$/;
                        if (ipOrDomainRegex.test(value)) {
                            let finalValue = value;
                            if (!/^https?:\/\//.test(value)) {
                                finalValue = 'https://' + value;
                            }
                            setCookie('authRedirectUrl', finalValue);
                            updateJumpHref();
                        }
                    } else {
                        setCookie('authRedirectUrl', '');
                        updateJumpHref();
                    }
                });

                addressDisplay.addEventListener('blur', function (e) {
                    const value = e.target.value.trim();
                    if (value) {
                        const ipOrDomainRegex = /^(https?:\/\/)?([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})?(:\d+)?$/;
                        if (ipOrDomainRegex.test(value)) {
                            let finalValue = value;
                            if (!/^https?:\/\//.test(value)) {
                                finalValue = 'https://' + value;
                            }
                            setCookie('authRedirectUrl', finalValue);
                            e.target.value = finalValue;
                            updateJumpHref();
                        }
                    }
                });
            }

            const params = getUrlParams();

            if (
                params.method === 'setRedirectUrl' &&
                typeof params.params === 'string'
            ) {
                const lang = translations[currentLang] || translations['zh-CN'];
                let ip = params.params.trim();
                const ipOrDomainRegex = /^(https?:\/\/)?([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})?(:\d+)?$/;
                let isValid = ipOrDomainRegex.test(ip);
                if (isValid && !/^https?:\/\//.test(ip)) {
                    ip = 'https://' + ip;
                }
                if (isValid) {
                    setCookie('authRedirectUrl', ip);
                    updateAddressDisplay();
                    showMsgHint(
                        lang.updateSuccessTitle || '地址更新成功',
                        (lang.updateSuccessContent || '当前跳转地址为：\r\n') + ip
                    );
                } else {
                    showMsgHint(
                        lang.updateErrorTitle || '地址无效',
                        lang.settingsInvalidIP || '请输入完整地址（如：https://192.168.1.100:8080）',
                        true
                    );
                }
                return;
            }

            if (Object.keys(params).length === 0) {
                console.log('no params, disable related buttons');

                const lang = translations[currentLang] || translations['zh-CN'];

                const copyButton = document.querySelector('.copy-button');
                if (copyButton) {
                    copyButton.style.pointerEvents = 'none';
                    copyButton.style.opacity = '0.5';
                    copyButton.title = lang.noParamsCopyTitle || '无参数可复制';
                }

                const jumpBtn = document.getElementById('buttonArea');
                if (jumpBtn) {
                    jumpBtn.style.pointerEvents = 'none';
                    jumpBtn.style.opacity = '0.5';
                    jumpBtn.href = '#';
                    jumpBtn.onclick = null;
                    jumpBtn.title = lang.noParamsJumpTitle || '无参数可跳转';
                }

                const textInput = document.getElementById('textInput');
                if (textInput) {
                    textInput.value = '';
                    textInput.placeholder = lang.noParamsPlaceholder || '无参数传入';
                }

                return;
            }

            const encodedData = encodeParamsToBase64(params);

            if (encodedData) {
                const textInput = document.getElementById('textInput');
                textInput.value = encodedData;
            } else {
                console.error('params encoding failed');
                const lang = translations[currentLang] || translations['zh-CN'];
                alert(lang.encodingFailed);
            }
        }

        function closePage() {
            try {
                window.opener = null;
                window.open('', '_self');
                window.close();

                setTimeout(function () {
                    if (!window.closed) {
                        showCloseHint();
                    }
                }, 200);
            } catch (error) {
                console.log('close page failed:', error);
                showCloseHint();
            }
        }

        function showCloseHint() {
            const currentLang = getBrowserLanguage();
            const lang = translations[currentLang] || translations['zh-CN'];

            const frame = document.querySelector('.frame');
            if (frame) {
                frame.style.display = 'none';
            }

            const closeHint = document.createElement('div');
            closeHint.id = 'closeHint';
            closeHint.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                text-align: center;
                z-index: 10000;
                max-width: 90%;
                width: 400px;
            `;

            closeHint.innerHTML = `
                <div style="font-size: 20px; font-weight: 500; margin-bottom: 20px; color: #000;">${lang.closeHintTitle || '请手动关闭页面'}</div>
                <div style="color: rgba(0, 0, 0, 0.6); line-height: 1.5;">${lang.closeHintContent || '由于浏览器安全限制，请手动关闭此页面'}</div>
            `;

            document.body.appendChild(closeHint);

            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                closeHint.style.background = '#1e1e1e';
                closeHint.style.color = '#ffffff';
                closeHint.querySelector('div:first-child').style.color = '#ffffff';
                closeHint.querySelector('div:last-child').style.color = 'rgba(255, 255, 255, 0.7)';
            }
        }

        function showMsgHint(title, content, isError) {
            const frame = document.querySelector('.frame');
            if (frame) frame.style.display = 'none';
            const old = document.getElementById('msgHint');
            if (old) old.remove();
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const msgHint = document.createElement('div');
            msgHint.id = 'msgHint';
            msgHint.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isDark ? '#1e1e1e' : 'white'};
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                text-align: center;
                z-index: 10000;
                max-width: 90%;
                width: 400px;
                color: ${isDark ? '#fff' : '#000'};
            `;
            msgHint.innerHTML = `
                <div style="font-size: 20px; font-weight: 500; margin-bottom: 20px; color: ${isDark ? (isError ? '#ff5c00' : '#fff') : (isError ? '#ff5c00' : '#000')};">${title}</div>
                <div style="color: ${isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.6)'}; line-height: 1.5;">${content}</div>
            `;
            document.body.appendChild(msgHint);
        }
    </script>
</body>

</html>